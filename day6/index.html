<body>
    <script>
        const input = `..#.....##......#............#..................................#.....#..............#................#.........................#.
    ..........................................................................................................#..........#...#.......#
    ..................#....................#.......................................#.....#....#............#.......#..................
    ......#...#..##....................................................................#...#.......#..........#..#.....#..............
    ..#..#.#.............#.#.........#.........##..................#..............#..........................#........................
    #..........#.................#..........#...............................#..#.................#.......##..##..#.#..................
    ......................#......................................................#........................#......................#....
    ........................#.#.....................................#..............................#.......#.............#.....#......
    #.................#...#......#..........#.......#.....#............................................#...........##.........#.....#.
    ...........................................#.....#............##...............#..............................#...................
    .....#..............#......................................#..........#............#..................##...............#......###.
    ..............#..#.....................................##................#............................#............#......#.......
    #........#...................................................#..........................................#.........................
    .................................................................................#................................#....#..#..#....
    .............................#.###.........#.#...............#..........................................##........................
    ......................................................................................................................#.........#.
    ...............#............#............#...#.........#............#.............................#.#........................#....
    ........................#...............#...............#........#.........#................#....#.#....................#.........
    ........#...............#...........................................................................................#.............
    .................#..........................................................#.....................................................
    ........#.#.#...................#..#.......#...........#..#............#......#.....................#.....#.........#..#..........
    ..#.......#..................................................................................................#......#.............
    ................##...##......................#....................................................#..............................#
    ............#......................................#...........................#.#...#...............#.....................##.....
    ..........#...................#.....................#...........................................##................................
    .#.......................#...............................................................#........................................
    ...................................................................#..#................#.....#....................#...............
    ...........#...........................................................#..........................................................
    .....#....#..#..........................................................#..................#.....................##...............
    ...#................................#.....#...................#...............##...........#..............#.......................
    .......##.....#.............#..#.......................................................................#......................#...
    ......................................#....#.............................................#...#....................#...............
    .......#.......#...............#..#.....#..............................#.#......#...............#.................................
    ......................#.......#.......#..........................................................#................#...........#...
    ..............................#........................#.......#..#...............................#...............................
    ...........................#..........#..##.......................#................#..............................................
    ..............#............#...##........#.................................#................#....#........................#..#....
    ..............#.........#............................................#.............#......#......#.#....#.........................
    .......................#.................................#..#..#..#..............................................#................
    ........................###..#...............................................................#.........#................#......#..
    #........................................................................................#........................................
    ........................................#..............................##.....#.........................#...........#.............
    .............#.........#...#................#..#..........#.....#...........................................................#.....
    .......................................#......#.............................#.........#................#..........................
    ..........................................................#......................#...........#...#.......#........................
    #.....................................#.#...#.............................................................#...........#........#..
    ............................#..................................................................................#............#.....
    #.................#.................................................................#..............#...................#..........
    ........#...................................................................#...............................................#.....
    .................#...#..................#.............................................................#.......#...................
    ...#.....#.................................................................................................#..........#...........
    ..........#...................................#....#................#......#........................................#.......#.....
    .....................................#...............#................................................................#...........
    .#............#................................................................#.............................................#....
    ...........#.........#.....................#...........#^.......................#.....................#..........#................
    .....#........#.................................................................................................#.......#.........
    ..........#..........................#.......#......................#..............................#....#......................#..
    ...#.........................#.................#....#........#....................................................................
    ...............#...#........................................#................................#....#........................#.#....
    ...........#.......................................#......#....#.......................................................#.......#..
    #.........#...............#..#..#..........#..............#...........................#...........#.....................#.........
    ...................#.......................................................#......................................................
    .............#..............................................#.......................................#.........#...........#......#
    ....#......#...#.................................#.....#......#.................................#.................................
    ...............#...............#......................................................................#...........................
    .......................#.........................................................................................................#
    .............................#............................................................................#.......................
    ...................#..#.........#...........................#......#...............#......#.......................................
    ...#....................................#...................#..#...........................#............#...............#........#
    ...................#................................................................#............##...............................
    ........................#.#...................#.....................................................................#...#.........
    ...................#......#.......#.#......................................................#...............#......................
    ....#...........................#................#.............................#..#....................#........##.....#..........
    .........................#......................................................#.#......................................#........
    .........#.............#.................#........................................................................................
    .#.#.......#..#....#.......#...#..#......................................................................#.#......................
    ..#.................#............................................................................#................................
    .#................................#...............................................................................................
    ..........#............#..............................................#...#...............##...............#..................#...
    ................................#.........................#.......................................................................
    ........................................................##.......#........................#.....................#.................
    ......#......................................................#......#.........#........................................#.......#..
    ...........................................................#............#....#......#.............................................
    ..................................#...................................................#.................................#...#.....
    .......#...#..........#............#.......#........................................#..#.................#........................
    ....................#........................................#........#...........................................................
    .................................##..#............#.................................#.............#..................#....#.......
    .#.................#..........#.....#...........#.......................................................#...................#.....
    ........................#.........................................................................................................
    ...#..........................................#...........................#.................................#.....................
    ............#......................................................#.................................#.........#..............#...
    .............#........##.........#..................#...#.............#......#....##................#................#............
    ..................#...........................................................................................#.................#.
    .....................#..#..#....................#........................#.........#................................#.............
    ..............................................#...................#............................#..............................#...
    .......................#.#...................................#.............................#...................................#..
    ................................#...........#.............................#.............#.........#..............................#
    ...........................#................................#...................................................#.....#...........
    ..........#..........#.....#..........#..#............#..........#.................#.......#.......#........................#....#
    ...#.......#...#..............................................................................................#......#......#.....
    ...........#......................#..#.................#......#.........#.....#.............#............##................#....#.
    .......#...........................................#..................#...............#.............................#.............
    ....#.......#.................................#..................................................................#................
    ..#..................................#...#............................#.........#....#..........#............................#....
    ....................................................#.................#...........................................#...............
    ............#......................................#.........#..................#.....#.#.#.#..#..................................
    #..............#.......#...#.#..............#.....#.#.............................................................................
    ...........#.#.................................#...#........................................#................#.........#....#.....
    ......#.........................................#.........................#...........................................#...........
    ...#......#.................................#......#............................................................................#.
    ...#.................#....##................#...........................................#.........#....#..........................
    ...........#...#...#..................#...................................#......................................#......#.....#.#.
    ...................................#....................#................#..................................................#.....
    ................#.....................................#...........#......#........................................................
    ..............................#......#..#..............................................##........#......#......................#.#
    #...........................#....#....##.....#...........................##..#...................#.....#........#.................
    ..........#....#.#..................#..........#..#................#.................#..................................##.......#
    ...................#.....................#......#...........................................................#..........#..........
    ........#.....#.............................#..............................................#......................................
    ......#............#.#.................................................................................................#..#.......
    .#.........#..................................................................................#....#...........#.................#
    ........#.....#.......................#.........................................#...........................................#.....
    ...................#.......#..#......#.................##......................................#...................#..............
    .............................#.................................#........#.......#..................................#.........#....
    ....#....#..........#....###..#...................................................#...#................................#.......#..
    ...................#...................................................#.......#....#........................#....................
    ...#................#...........#.......................#.....................................#...#......#......#.................
    .......#........................#.........#.............................................................#...#...#.................
    ....................#.........#..............................#..........................#....................#..#.................
    ..#..........................#.#...................................#..................#..........#................#...............`;

        const test = `....#.....
    .........#
    ..........
    ..#.......
    .......#..
    ..........
    .#..^.....
    ........#.
    #.........
    ......#...`;

        const body = document.querySelector("body");

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.height = 1200;
        canvas.width = canvas.height;

        const stateCanvas = document.createElement("canvas");
        const stateCtx = stateCanvas.getContext("2d");
        stateCtx.font = "70px Arial";

        stateCanvas.height = 400;
        stateCanvas.width = stateCanvas.height * 3;
        const visitedElement = document.createElement("pre");

        body.appendChild(canvas);
        body.appendChild(stateCanvas);
        body.appendChild(visitedElement);

        const assert = (condition, msg) => {
            if (!condition) throw new Error(msg);
        };
        const fromCord = ([y, x]) => {
            assert(
                y != null && x != null,
                `Failed to get cord key, got values y:${y} x:${x}`,
            );
            return `${y},${x}`;
        };

        const asCord = (cord) => {
            assert(Boolean(cord), "As cord null");
            const parts = cord.split(",");
            assert(
                parts.length == 2,
                `Cord split wrong parts:${parts}, cord:${cord}`,
            );
            const [y, x] = parts;
            assert(y >= 0 && x >= 0, "cords negeative");
            return [y, x];
        };

        const render = (grid, guard, obstacles, visited) => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            stateCtx.clearRect(0, 0, stateCanvas.width, stateCanvas.height);

            const cellsize = canvas.width / grid.w;
            for (let y = 0; y < grid.h; y++) {
                for (let x = 0; x < grid.w; x++) {
                    ctx.strokeRect(
                        x * cellsize,
                        y * cellsize,
                        cellsize,
                        cellsize,
                    );
                }
            }
            for (const o of obstacles) {
                const [y, x] = asCord(o);
                ctx.fillRect(x * cellsize, y * cellsize, cellsize, cellsize);
            }
            let temp = ctx.fillStyle;
            ctx.fillStyle = guard.coliding ? "red" : "green";
            ctx.fillRect(
                guard.x * cellsize,
                guard.y * cellsize,
                cellsize,
                cellsize,
            );
            ctx.fillStyle = temp;

            stateCtx.font = "40px Arial";

            const state = { ...guard, visited: visited.size };
            stateCtx.fillText(JSON.stringify(state), 50, 50);
        };

        const parseInput = (input) => {
            const lines = input.split("\n");
            const GUARD = "^";
            const OBSTACLE = "#";

            let guardLoc = [0, 0];
            const [dx, dy] = [0, -1];
            const obstacles = new Set();

            for (let y = 0; y < lines.length; y++) {
                for (let x = 0; x < lines[y].length; x++) {
                    if (lines[y][x] == GUARD) {
                        guardLoc = [y, x];
                    }
                    if (lines[y][x] == OBSTACLE) {
                        obstacles.add(fromCord([y, x]));
                    }
                }
            }

            return {
                grid: {
                    h: lines.length,
                    w: lines[0].length,
                },
                guard: {
                    y: guardLoc[0],
                    x: guardLoc[1],
                    dy: dy,
                    dx: dx,
                    coliding: false,
                },
                obstacles: obstacles,
            };
        };

        const newDirection = ([dy, dx]) => {
            assert(dy == -1 || dy == 1 || dy == 0, "Invalid dy", dy);
            assert(dx == -1 || dx == 1 || dx == 0, "Invalid dx", dx);
            if (-1 == dy && 0 == dx) return [0, 1]; /// up to right
            if (1 == dy && 0 == dx) return [0, -1]; // dow to left
            if (0 == dy && 1 == dx) return [1, 0]; // right to down
            if (0 == dy && -1 == dx) return [-1, 0]; // let to up

            throw new Error("Invalid cords ", [dy, dx]);
        };

        function inBounds(y, x, grid) {
            return y >= 0 && y < grid.h && x >= 0 && x < grid.w;
        }

        function* run() {
            const visited = new Set();
            const { guard, grid, obstacles } = parseInput(input);

            while (!obstacles[fromCord([guard.y, guard.x])]) {
                const { y, x } = guard;
                guard.y += guard.dy;
                guard.x += guard.dx;

                const newCord = [guard.y, guard.x];

                const [ny, nx] = newCord;
                if (!inBounds(ny, nx, grid)) {
                    yield { guard, grid, obstacles, visited };
                    return;
                }

                if (obstacles.has(fromCord(newCord))) {
                    guard.coliding = true;

                    guard.y -= guard.dy;
                    guard.x -= guard.dx;
                    yield { guard, grid, obstacles, visited };
                    const [ndy, ndx] = newDirection([guard.dy, guard.dx]);

                    guard.dy = ndy;
                    guard.dx = ndx;
                } else {
                    const key = fromCord([guard.y, guard.x]);
                    visited.add(key);
                    guard.coliding = false;
                }
                yield { guard, grid, obstacles, visited };

                assert(
                    y >= 0 && y < grid.h && x >= 0 && x < grid.w,
                    `Guard out of bounds: ${guard.y}, ${guard.x}`,
                );
            }
        }

        const state = run();
        let advance = true;
        const useMouse = false;

        const tick = () => {
            if (useMouse) {
                if (advance) {
                    const val = state.next().value;
                    if (!val) return;
                    const { guard, grid, obstacles, visited } = val;
                    render(grid, guard, obstacles, visited);
                    advance = false;
                }
            } else {
                val = state.next().value;
                if (!val) return;
                const { guard, grid, obstacles, visited } = val;
                render(grid, guard, obstacles, visited);
            }

            requestAnimationFrame(tick);
        };

        tick();

        document.addEventListener("click", function (event) {
            advance = true;
        });
    </script>
</body>
